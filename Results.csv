Id,IsSystem,AttributeId,Key,Value,Guid,ForeignKey,ForeignGuid,ForeignId
152515,0,19838,fieldtype,ddl,b2f6386e-9a86-429e-a218-0e9086b9e015,NULL,NULL,NULL
152516,0,19838,repeatColumns,,233b916e-7d36-40b4-9e9f-bb4d03a9d714,NULL,NULL,NULL
152517,0,19838,values,"DECLARE @Campus NVARCHAR(400) = ''
	DECLARE @GroupDemographics NVARCHAR(400) = ''
	DECLARE @Day NVARCHAR(400) = ''
	DECLARE @Topic NVARCHAR(400) = ''
	DECLARE @Method NVARCHAR(400) = ''

	SELECT DISTINCT [Location].City [Value], [Location].City [Text]
	FROM [Group] AS g
	LEFT JOIN Campus c ON g.CampusId = c.Id
	LEFT JOIN Schedule s ON g.ScheduleId = s.Id
	LEFT JOIN AttributeValue avTitle ON g.Id = avTitle.EntityId AND avTitle.AttributeId = 16365
	LEFT JOIN AttributeValue avDemo ON g.Id = avDemo.EntityId AND avDemo.AttributeId = 5920
    LEFT JOIN AttributeValue avMethod ON g.Id = avMethod.EntityId AND avMethod.AttributeId = 19604
    LEFT JOIN DefinedValue AS methoddf ON avMethod.[Value] = methoddf.Guid
	OUTER APPLY (
		SELECT TOP 1 l.City
		FROM GroupLocation gl
		INNER JOIN [Location] l ON gl.GroupId = g.Id AND l.Id = gl.LocationId
	) [location]
	LEFT JOIN [AttributeValue] AS av ON g.Id = av.EntityId AND av.AttributeId = 6309
	LEFT JOIN AttributeMatrix AS am ON av.[Value] = convert(nvarchar(50), am.Guid)
	LEFT JOIN AttributeMatrixItem AS cami ON am.Id = cami.AttributeMatrixId
	LEFT JOIN AttributeValue AS cqav ON cami.Id = cqav.EntityId AND cqav.AttributeId = 6312
	LEFT JOIN AttributeValue AS ctav ON cami.Id = ctav.EntityId AND ctav.AttributeId = 6307
	LEFT JOIN AttributeValue AS cEndDate ON cami.Id = cEndDate.EntityId AND cEndDate.AttributeId = 13733
	LEFT JOIN DefinedValue AS cqdf ON cqav.[Value] = cqdf.Guid
	LEFT JOIN DefinedValue AS ctdf ON ctav.[Value] = ctdf.Guid
	LEFT JOIN AttributeValue AS ctdfReg ON ctdf.Id = ctdfReg.EntityId AND ctdfReg.AttributeId = 16398
	LEFT JOIN AttributeValue AS ctdfShow ON ctdf.Id = ctdfShow.EntityId AND ctdfShow.AttributeId = 16399
	LEFT JOIN AttributeValue AS ctdfShort ON ctdf.Id = ctdfShort.EntityId AND ctdfShort.AttributeId = 16403
	LEFT JOIN AttributeValue AS ctdfColor ON ctdf.Id = ctdfColor.EntityId AND ctdfColor.AttributeId = 16404
	LEFT JOIN DefinedValue AS ctColordv ON ctdfColor.[Value] = ctColordv.Guid
	LEFT JOIN AttributeValue AS ctdfStyle ON ctColordv.Id = ctdfStyle.EntityId AND ctdfStyle.AttributeId = 16405
	OUTER APPLY
	(
		SELECT TOP 1 link.UrlSlug,
		CASE
			WHEN ri.MaxAttendees = 0 THEN ''
			ELSE ri.MaxAttendees - COUNT(DISTINCT rr.Id)
		END AS SpotsRemaining
		FROM EventItemOccurrenceGroupMap link
		INNER JOIN RegistrationInstance ri ON link.RegistrationInstanceId = ri.Id AND (ri.EndDateTime > GETDATE() OR ri.EndDateTime IS NULL) AND (ri.StartDateTime <= GETDATE() OR ri.StartDateTime IS NULL) AND ri.IsActive = 1
		INNER JOIN RegistrationTemplate rt ON ri.RegistrationTemplateId = rt.Id AND rt.IsActive = 1
		LEFT JOIN Registration r ON ri.Id = r.RegistrationInstanceId
		LEFT JOIN RegistrationRegistrant rr ON r.Id = rr.RegistrationId AND rr.OnWaitList != 1
		WHERE link.UrlSlug IS NOT NULL AND link.UrlSlug != '' AND link.GroupId = g.Id
		Group BY link.Id, link.UrlSlug, ri.MaxAttendees
		HAVING ( COUNT(DISTINCT rr.Id) < ri.MaxAttendees OR ri.MaxAttendees IS NULL )
	 ) link
	 OUTER APPLY(
		 SELECT COUNT(DISTINCT gm.PersonId) AS [Count]
		 FROM GroupMember gm
		 WHERE gm.GroupId = g.Id AND gm.IsArchived = 0
	 ) member
	OUTER APPLY (
		SELECT STRING_AGG(p.NickName + ' ' + p.LastName, ', ') AS Names
		FROM GroupMember gm
		INNER JOIN GroupTypeRole gmr ON gm.GroupRoleId = gmr.Id AND gmr.IsLeader = 1 AND gm.GroupMemberStatus != 0 AND gm.IsArchived = 0
		INNER JOIN [Person] p ON gm.GroupId = g.Id AND p.Id = gm.PersonId
	) [leaders]
	WHERE
		(g.GroupTypeId = 49 AND g.IsActive = 1 AND g.IsArchived != 1 AND g.IsPublic = 1)
	AND (ctdfReg.ValueAsBoolean = 0 OR link.UrlSlug IS NOT NULL)
    AND (cqdf.[Value] = 'Spring 2021' OR
			(link.UrlSlug IS NOT NULL AND (cEndDate.ValueAsDateTime IS NOT NULL AND cEndDate.ValueAsDateTime > GETDATE() ) )
		)
	AND (ctdfReg.ValueAsBoolean = 0 OR link.UrlSlug IS NOT NULL)
	AND (( ctdfShow.[ValueAsBoolean] = 1 AND @Topic = '')
			OR  ctdf.[Value] LIKE @Topic + '%'  )
	AND (g.GroupCapacity IS NULL OR g.GroupCapacity > member.[Count])
    AND ([Location].City IS NOT NULL AND [Location].[City] !='')
	ORDER BY [Location].City",d858428f-4a1b-4b43-ba4c-7451b7605c62,NULL,NULL,NULL
